<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>@softwarity/geojson-editor - Demo</title>
  <!-- MapLibre GL JS - Latest version with globe support -->
  <link href="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.js"></script>
  <style>
    :root {
      --bg-canvas: #0d1117;
      --bg-primary: #161b22;
      --bg-secondary: #21262d;
      --border-default: #30363d;
      --text-primary: #e6edf3;
      --text-secondary: #c9d1d9;
      --text-muted: #8b949e;
      --accent-blue: #58a6ff;
      --accent-green: #238636;
      --accent-green-hover: #2ea043;
      --accent-purple: #a371f7;
      --accent-red: #f85149;
      --font-mono: 'Courier New', monospace;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    /* Palette icon using CSS mask */
    .icon-palette {
      display: inline-block;
      width: 18px;
      height: 18px;
      background-color: currentColor;
      mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 -960 960 960'%3E%3Cpath d='M480-80q-82 0-155-31.5t-127.5-86Q143-252 111.5-325T80-480q0-83 32.5-156t88-127Q256-817 330-848.5T488-880q80 0 151 27.5t124.5 76q53.5 48.5 85 115T880-518q0 115-70 176.5T640-280h-74q-9 0-12.5 5t-3.5 11q0 12 15 34.5t15 51.5q0 50-27.5 74T480-80Zm0-400Zm-220 40q26 0 43-17t17-43q0-26-17-43t-43-17q-26 0-43 17t-17 43q0 26 17 43t43 17Zm120-160q26 0 43-17t17-43q0-26-17-43t-43-17q-26 0-43 17t-17 43q0 26 17 43t43 17Zm200 0q26 0 43-17t17-43q0-26-17-43t-43-17q-26 0-43 17t-17 43q0 26 17 43t43 17Zm120 160q26 0 43-17t17-43q0-26-17-43t-43-17q-26 0-43 17t-17 43q0 26 17 43t43 17ZM480-160q9 0 14.5-5t5.5-13q0-14-15-33t-15-57q0-42 29-67t71-25h70q66 0 113-38.5T800-518q0-121-92.5-201.5T488-800q-136 0-232 93t-96 227q0 133 93.5 226.5T480-160Z'/%3E%3C/svg%3E");
      mask-size: contain;
      mask-repeat: no-repeat;
      -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 -960 960 960'%3E%3Cpath d='M480-80q-82 0-155-31.5t-127.5-86Q143-252 111.5-325T80-480q0-83 32.5-156t88-127Q256-817 330-848.5T488-880q80 0 151 27.5t124.5 76q53.5 48.5 85 115T880-518q0 115-70 176.5T640-280h-74q-9 0-12.5 5t-3.5 11q0 12 15 34.5t15 51.5q0 50-27.5 74T480-80Zm0-400Zm-220 40q26 0 43-17t17-43q0-26-17-43t-43-17q-26 0-43 17t-17 43q0 26 17 43t43 17Zm120-160q26 0 43-17t17-43q0-26-17-43t-43-17q-26 0-43 17t-17 43q0 26 17 43t43 17Zm200 0q26 0 43-17t17-43q0-26-17-43t-43-17q-26 0-43 17t-17 43q0 26 17 43t43 17Zm120 160q26 0 43-17t17-43q0-26-17-43t-43-17q-26 0-43 17t-17 43q0 26 17 43t43 17ZM480-160q9 0 14.5-5t5.5-13q0-14-15-33t-15-57q0-42 29-67t71-25h70q66 0 113-38.5T800-518q0-121-92.5-201.5T488-800q-136 0-232 93t-96 227q0 133 93.5 226.5T480-160Z'/%3E%3C/svg%3E");
      -webkit-mask-size: contain;
      -webkit-mask-repeat: no-repeat;
    }
    .icon-palette.large { width: 20px; height: 20px; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      padding: 2rem;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: var(--bg-primary);
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      border: 1px solid var(--border-default);
    }

    h1 { color: var(--text-primary); margin-bottom: 1rem; font-size: 2rem; }

    /* Shared section styles */
    .section-box {
      margin-top: 2rem;
      padding: 1rem;
      background: var(--bg-secondary);
      border-radius: 8px;
      border: 1px solid var(--border-default);
    }
    .section-box h3 { color: var(--text-primary); margin-bottom: 0.5rem; }
    .section-box p { color: var(--text-muted); }

    /* Log container with floating clear button */
    .log-container {
      position: relative;
    }
    .log-container pre {
      padding-bottom: 2.5rem; /* Space for the clear button */
    }
    .btn-clear {
      position: absolute;
      bottom: 0.5rem;
      right: 1.5rem; /* Space for scrollbar */
      padding: 0.2rem 0.4rem;
      font-size: 0.9rem;
      opacity: 0.5;
      line-height: 1;
    }
    .btn-clear:hover {
      opacity: 1;
    }
    .section-box pre {
      background: var(--bg-canvas);
      color: var(--text-secondary);
      padding: 1rem;
      border-radius: 4px;
      overflow: auto;
      font-family: var(--font-mono);
      font-size: 0.85rem;
      border: 1px solid var(--border-default);
    }

    .text-muted { color: var(--text-muted); font-size: 0.85rem; }
    .text-small { font-size: 0.8rem; color: var(--text-muted); margin-left: 0.5rem; }
    .flex-row { display: flex; gap: 0.5rem; }
    .flex-wrap { display: flex; gap: 2rem; flex-wrap: wrap; }

    .description { color: var(--text-muted); margin-bottom: 2rem; line-height: 1.6; }
    .description strong { color: var(--text-secondary); }

    .controls {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      margin-bottom: 2rem;
      padding: 1.5rem;
      background: var(--bg-secondary);
      border-radius: 8px;
      border: 1px solid var(--border-default);
    }

    .controls-section { display: flex; flex-direction: column; gap: 1rem; }
    .controls-section h4 {
      margin: 0;
      color: var(--text-primary);
      font-size: 1rem;
      border-bottom: 2px solid var(--accent-blue);
      padding-bottom: 0.5rem;
    }
    .controls-section > p { color: var(--text-muted); }

    .controls-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
    }

    .control-group { display: flex; flex-direction: column; gap: 0.5rem; }
    .control-group label { font-weight: 600; color: var(--text-secondary); font-size: 0.9rem; }

    .control-group select,
    .control-group input[type="text"],
    .control-group textarea {
      padding: 0.5rem;
      border: 1px solid var(--border-default);
      border-radius: 4px;
      font-size: 0.9rem;
      font-family: var(--font-mono);
      background: var(--bg-canvas);
      color: var(--text-secondary);
    }
    .control-group select:focus,
    .control-group input[type="text"]:focus,
    .control-group textarea:focus {
      outline: none;
      border-color: var(--accent-blue);
    }

    .checkbox-group { display: flex; align-items: center; gap: 0.5rem; }
    .checkbox-group label { margin: 0; color: var(--text-secondary); }

    .editor-map-row {
      display: flex;
      gap: 1rem;
      margin-top: 2rem;
    }

    .editor-container {
      flex: 1;
      min-width: 0;
      padding: 1rem;
      background: var(--bg-secondary);
      border: 1px solid rgba(88, 166, 255, 0.4);
      border-radius: 8px;
    }

    .editor-label {
      margin: 0 0 0.5rem 0;
      color: var(--text-primary);
      font-weight: 600;
    }

    .map-container {
      flex: 1;
      min-width: 0;
      padding: 1rem;
      background: var(--bg-secondary);
      border: 1px solid rgba(163, 113, 247, 0.4);
      border-radius: 8px;
    }

    .map-label {
      margin: 0 0 0.5rem 0;
      color: var(--text-primary);
      font-weight: 600;
    }

    #map {
      width: 100%;
      height: 400px;
      border-radius: 4px;
    }

    @media (max-width: 900px) {
      .editor-map-row {
        flex-direction: column;
      }
    }

    .output pre { max-height: 400px; }
    .output.error { border-color: rgba(248, 81, 73, 0.4); }
    .output.error h3 { color: var(--accent-red); }

    .code-example pre { line-height: 1.5; margin: 0; }

    /* Base button - neutral/primary style (dark) */
    button, .btn {
      padding: 0.5rem 1rem;
      background: var(--bg-canvas);
      color: var(--text-secondary);
      border: 1px solid var(--border-default);
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }
    button:hover, .btn:hover {
      background: var(--border-default);
      color: var(--text-primary);
    }

    /* Action button - green for primary actions (Execute, Apply) */
    .btn-action {
      background: var(--accent-green);
      color: white;
      border-color: var(--accent-green);
    }
    .btn-action:hover {
      background: var(--accent-green-hover);
      border-color: var(--accent-green-hover);
      color: white;
    }

    /* Icon button - compact, for icons only */
    .btn-icon {
      padding: 0.4rem 0.6rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    /* Accent button - purple for secondary actions */
    .btn-accent {
      background: var(--accent-purple);
      color: white;
      border-color: var(--accent-purple);
    }
    .btn-accent:hover {
      background: #8b5cf6;
      border-color: #8b5cf6;
      color: white;
    }

    .header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem; }
    .header h1 { margin: 0; flex: 1; }

    .github-link {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: var(--bg-secondary);
      color: var(--text-secondary);
      text-decoration: none;
      border-radius: 6px;
      font-weight: 600;
      font-size: 0.9rem;
      transition: background 0.2s;
      border: 1px solid var(--border-default);
    }
    .github-link:hover { background: var(--border-default); }
    .github-link svg { width: 20px; height: 20px; fill: currentColor; }

    .info-box {
      background: var(--bg-canvas);
      padding: 0.75rem;
      border-radius: 4px;
      margin-top: 1rem;
      font-size: 0.85rem;
      color: var(--text-muted);
      border-left: 3px solid var(--accent-blue);
    }

    /* Prism.js syntax highlighting - shared tokens */
    .code-example .token.comment, .code-example .token.prolog, .code-example .token.doctype { color: var(--text-muted); }
    .code-example .token.punctuation, .code-example .token.operator, .code-example .token.entity, .code-example .token.url, .code-example .token.variable { color: var(--text-secondary); }
    .code-example .token.property, .code-example .token.tag, .code-example .token.boolean, .code-example .token.number, .code-example .token.constant, .code-example .token.symbol { color: #79c0ff; }
    .code-example .token.selector, .code-example .token.attr-name, .code-example .token.string, .code-example .token.char, .code-example .token.builtin { color: #a5d6ff; }
    .code-example .token.atrule, .code-example .token.attr-value, .code-example .token.keyword { color: #ff7b72; }
    .code-example .token.function { color: #d2a8ff; }
    .code-example .token.regex, .code-example .token.important { color: #ffa657; }

    /* JSON syntax highlighting for event log */
    .json-highlight .token.punctuation { color: var(--text-secondary); }
    .json-highlight .token.property { color: #79c0ff; }
    .json-highlight .token.string { color: #a5d6ff; }
    .json-highlight .token.number { color: #79c0ff; }
    .json-highlight .token.boolean { color: #ff7b72; }
    .json-highlight .token.null { color: #ff7b72; }
    .json-highlight .token.operator { color: var(--text-secondary); }

    /* Modal */
    .modal { position: fixed; inset: 0; z-index: 1000; display: flex; align-items: center; justify-content: center; }
    .modal-backdrop { position: absolute; inset: 0; background: rgba(0, 0, 0, 0.7); }
    .modal-content {
      position: relative;
      background: var(--bg-primary);
      border-radius: 12px;
      width: 90%;
      max-width: 700px;
      max-height: 90vh;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      border: 1px solid var(--border-default);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border-default);
      background: var(--bg-secondary);
    }
    .modal-header h3 { margin: 0; color: var(--text-primary); }
    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-muted);
      padding: 0;
      line-height: 1;
    }
    .modal-close:hover { color: var(--text-primary); }
    .modal-body { padding: 1.5rem; overflow-y: auto; max-height: calc(90vh - 60px); }
    .modal-body p { color: var(--text-muted); }
    .theme-actions { display: flex; gap: 0.5rem; margin-top: 1rem; flex-wrap: wrap; justify-content: flex-end; }

    #themeTextarea {
      width: 100%;
      font-family: var(--font-mono);
      font-size: 0.85rem;
      padding: 1rem;
      border: 1px solid var(--border-default);
      border-radius: 4px;
      resize: vertical;
      background: var(--bg-canvas);
      color: var(--text-secondary);
    }
    #themeTextarea:focus { outline: none; border-color: var(--accent-blue); }

    /* API Toolbar */
    .api-toolbar {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-top: 1rem;
      padding: 1rem;
      background: var(--bg-secondary);
      border-radius: 8px;
      border: 1px solid var(--border-default);
    }
    .api-toolbar h4 {
      width: 100%;
      margin: 0 0 0.5rem 0;
      color: var(--text-primary);
      font-size: 0.9rem;
      border-bottom: 2px solid var(--accent-purple);
      padding-bottom: 0.5rem;
    }
    .api-btn {
      padding: 0.5rem 1rem;
      background: var(--accent-purple);
      color: white;
      border: 1px solid var(--accent-purple);
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.85rem;
      transition: all 0.2s;
    }
    .api-btn:hover {
      background: #8b5cf6;
      border-color: #8b5cf6;
      box-shadow: 0 2px 8px rgba(139, 92, 246, 0.4);
    }
    .api-btn.danger {
      background: var(--accent-red);
      border-color: var(--accent-red);
    }
    .api-btn.danger:hover {
      background: #dc2626;
      border-color: #dc2626;
      box-shadow: 0 2px 8px rgba(220, 38, 38, 0.4);
    }

    /* API Modal */
    .api-modal-body { padding: 1.5rem; }
    .api-modal-body label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--text-secondary);
      font-weight: 600;
    }
    .api-modal-body textarea {
      width: 100%;
      min-height: 200px;
      font-family: var(--font-mono);
      font-size: 0.85rem;
      padding: 1rem;
      border: 1px solid var(--border-default);
      border-radius: 4px;
      resize: vertical;
      background: var(--bg-canvas);
      color: var(--text-secondary);
    }
    .api-modal-body textarea:focus { outline: none; border-color: var(--accent-blue); }
    .api-modal-body input[type="number"] {
      width: 100%;
      padding: 0.75rem;
      font-family: var(--font-mono);
      font-size: 1rem;
      border: 1px solid var(--border-default);
      border-radius: 4px;
      background: var(--bg-canvas);
      color: var(--text-secondary);
    }
    .api-modal-body input[type="number"]:focus { outline: none; border-color: var(--accent-blue); }
    .api-modal-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
      justify-content: flex-end;
    }
    .api-modal-actions button { min-width: 100px; }
    .api-modal-error {
      margin-top: 0.5rem;
      padding: 0.5rem;
      background: rgba(248, 81, 73, 0.1);
      border: 1px solid var(--accent-red);
      border-radius: 4px;
      color: var(--accent-red);
      font-size: 0.85rem;
    }
    .form-group { margin-bottom: 1rem; }
    .form-group:last-of-type { margin-bottom: 0; }

    /* Toast animations */
    @keyframes toastFadeIn {
      from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
      to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    }
    @keyframes toastFadeOut {
      from { opacity: 1; transform: translate(-50%, -50%) scale(1); }
      to { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <div style="display: flex; align-items: center; gap: 1rem;">
        <a href="https://www.softwarity.io/" target="_blank" rel="noopener noreferrer" title="Softwarity">
          <img src="https://www.softwarity.io/img/softwarity.svg" alt="Softwarity" style="height: 40px;">
        </a>
        <div>
          <h1 style="margin-bottom: 0.5rem;">@softwarity/geojson-editor</h1>
          <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
            <a href="https://www.npmjs.com/package/@softwarity/geojson-editor" target="_blank" rel="noopener">
              <img src="https://img.shields.io/npm/v/@softwarity/geojson-editor?color=blue&label=npm" alt="npm version">
            </a>
            <a href="https://bundlephobia.com/package/@softwarity/geojson-editor" target="_blank" rel="noopener">
              <img src="https://img.shields.io/bundlephobia/minzip/@softwarity/geojson-editor?label=size" alt="bundle size">
            </a>
            <a href="https://github.com/softwarity/geojson-editor/blob/main/LICENSE" target="_blank" rel="noopener">
              <img src="https://img.shields.io/badge/license-MIT-blue" alt="license">
            </a>
            <a href="https://codecov.io/gh/softwarity/geojson-editor" target="_blank" rel="noopener">
              <img src="https://codecov.io/gh/softwarity/geojson-editor/graph/badge.svg" alt="codecov">
            </a>
          </div>
        </div>
      </div>
      <div style="display: flex; gap: 1rem; align-items: center;">
        <a href="https://github.com/softwarity/geojson-editor#readme" target="_blank" rel="noopener noreferrer" class="github-link">
          <svg viewBox="0 0 16 16" aria-hidden="true">
            <path d="M0 1.75A.75.75 0 01.75 1h4.253c1.227 0 2.317.59 3 1.501A3.744 3.744 0 0111.006 1h4.245a.75.75 0 01.75.75v10.5a.75.75 0 01-.75.75h-4.507a2.25 2.25 0 00-1.591.659l-.622.621a.75.75 0 01-1.06 0l-.622-.621A2.25 2.25 0 005.258 13H.75a.75.75 0 01-.75-.75V1.75zm8.755 3a2.25 2.25 0 012.25-2.25H14.5v9h-3.757c-.71 0-1.4.201-1.992.572l.004-7.322zm-1.504 7.324l.004-5.073-.002-2.253A2.25 2.25 0 005.003 2.5H1.5v9h3.757a3.75 3.75 0 011.994.574z"></path>
          </svg>
          Documentation
        </a>
        <a href="https://github.com/softwarity/geojson-editor" target="_blank" rel="noopener noreferrer" class="github-link">
          <svg viewBox="0 0 16 16" aria-hidden="true">
            <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
          </svg>
          GitHub
        </a>
        <a href="https://www.softwarity.io/" target="_blank" rel="noopener noreferrer" class="github-link">
          <svg viewBox="0 0 16 16" aria-hidden="true">
            <path d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0ZM1.5 8a6.5 6.5 0 1 0 13 0 6.5 6.5 0 0 0-13 0Zm4.879-2.773l.627 2.197a.75.75 0 0 1-.724.949H4.25a.75.75 0 0 1 0-1.5h.846l-.313-1.097a.75.75 0 0 1 1.446-.424l.15.525Zm5.742.424a.75.75 0 0 0-1.446.424l.15.525-.313 1.097h-.847a.75.75 0 0 0 0 1.5h2.033a.75.75 0 0 0 .724-.949l-.627-2.197-.001-.001a.75.75 0 0 0 .327-.399Z"></path>
          </svg>
          Softwarity
        </a>
      </div>
    </div>
    <div class="description">
      A lightweight Web Component for editing GeoJSON — with built-in validation, contextual type highlighting, auto-collapse coordinates, and feature visibility toggle (eye icon to hide/show features from events).
      <span style="color: var(--text-muted);">No Monaco (2.5 MB), no CodeMirror (150 KB), just what you need for GeoJSON.</span>
    </div>

    <div class="controls">
      <div class="controls-section">
        <h4>Theme</h4>
        <div class="controls-grid">
          <div class="control-group">
            <label for="colorSchemeSelect">Color Scheme</label>
            <select id="colorSchemeSelect">
              <option value="dark" selected>Dark</option>
              <option value="light">Light</option>
            </select>
          </div>
          <div class="control-group">
            <label for="themePresetMainSelect">Theme Preset</label>
            <div style="display: flex; gap: 0.5rem;">
              <select id="themePresetMainSelect" style="flex: 1;">
                <option value="intellij" selected>IntelliJ (Default)</option>
                <option value="vscode">VSCode</option>
                <option value="github">GitHub</option>
                <option value="onedark">One Dark / One Light</option>
                <option value="solarized">Solarized</option>
              </select>
              <button class="btn-icon btn-accent" onclick="openThemeModal()" title="Edit theme"><span class="icon-palette"></span></button>
            </div>
          </div>
        </div>
      </div>

      <div class="controls-section">
        <h4>Dark Mode Detection</h4>
        <p style="color: #666; font-size: 0.85rem; margin-bottom: 1rem;">
          The <code>dark-selector</code> attribute lets you specify a CSS selector. The component watches for this selector
          to match, and when it does, applies its dark theme. You can use any valid CSS selector.
        </p>
        <div class="controls-grid">
          <div class="control-group">
            <label for="darkSelectorExampleSelect">Examples</label>
            <select id="darkSelectorExampleSelect">
              <option value=".dark">Self</option>
              <option value="html.dark">Tailwind CSS</option>
              <option value="html[data-bs-theme=dark]">Bootstrap</option>
            </select>
          </div>
          <div class="control-group">
            <label for="selectorPreview">Attribute Value</label>
            <input type="text" id="selectorPreview" value="dark-selector='.dark'" readonly style="font-size: 0.8rem; background: #0d1117; border-color: #30363d;">
          </div>
        </div>
        <div id="selectorDescription" style="background: #0d1117; padding: 0.75rem; border-radius: 4px; margin-top: 1rem; font-size: 0.85rem; color: #8b949e; border-left: 3px solid #58a6ff;">
          <strong>Example:</strong> <code>.dark</code> — The component watches for a <code>dark</code> class on itself. When present, dark theme is applied.
        </div>
      </div>

      <div class="controls-section">
        <h4>Editor Options</h4>
        <div class="control-group" style="margin-bottom: 1rem;">
          <label for="placeholderInput">Placeholder Text (supports multi-line)</label>
          <textarea id="placeholderInput" rows="4">Enter GeoJSON features here...

Example:
{ "type": "Feature", "geometry": {...} }</textarea>
          <small style="color: #666; font-size: 0.85rem;">Shown when editor is empty</small>
        </div>
        <div style="display: flex; gap: 2rem; flex-wrap: wrap;">
          <div class="checkbox-group">
            <input type="checkbox" id="readonlyCheck">
            <label for="readonlyCheck">Readonly mode</label>
            <small style="color: #888; font-size: 0.8rem; margin-left: 0.5rem;">— disable editing</small>
          </div>
        </div>
        <div class="info-box">
          <strong>Note:</strong> Edit features directly (comma-separated). The component wraps them in a FeatureCollection and emits the complete structure on change events.
        </div>
      </div>

      <div class="controls-section">
        <h4>Default Properties</h4>
        <p style="color: #666; font-size: 0.85rem; margin-bottom: 1rem;">
          Define default properties to add to features on <code>change</code> events. Useful for visualization styling (fill-color, stroke-color, etc.) in your mapping framework. Properties are only added if not already defined on the feature.
        </p>
        <div class="control-group" style="margin-bottom: 1rem;">
          <label for="defaultPropsSelect">Preset Examples</label>
          <select id="defaultPropsSelect">
            <option value="">None (disabled)</option>
            <option value="simple">Simple (all features)</option>
            <option value="geometry">By Geometry Type</option>
            <option value="combined" selected>Combined (fallback + conditions)</option>
          </select>
        </div>
        <div class="control-group">
          <label for="defaultPropsInput">Configuration (JSON)</label>
          <textarea id="defaultPropsInput" rows="6" style="font-size: 0.8rem;"></textarea>
          <small style="color: #666; font-size: 0.85rem;">Edit the JSON or select a preset above</small>
        </div>
        <div id="defaultPropsDescription" class="info-box" style="margin-top: 1rem;"></div>
      </div>
    </div>

    <div class="editor-map-row">
      <div class="editor-container">
        <div class="editor-label">GeoJSON Editor</div>
        <geojson-editor id="editor"></geojson-editor>
      </div>
      <div class="map-container">
        <div class="map-label">MapLibre Preview</div>
        <div id="map"></div>
      </div>
    </div>

    <!-- API Toolbar -->
    <div class="api-toolbar">
      <h4>Features API</h4>
      <button class="api-btn" onclick="openApiModal('set')">set()</button>
      <button class="api-btn" onclick="openApiModal('add')">add()</button>
      <button class="api-btn" onclick="openApiModal('insertAt')">insertAt()</button>
      <button class="api-btn" onclick="openApiModal('removeAt')">removeAt()</button>
      <button class="api-btn danger" onclick="apiRemoveAll()">removeAll()</button>
      <button class="api-btn" onclick="apiEmit()">emit()</button>
    </div>

    <div class="section-box output">
      <h3>Change Events:</h3>
      <p>
        The component emits <code>change</code> events with <code>e.detail</code> containing the parsed GeoJSON object directly.
      </p>
      <div class="log-container">
        <pre id="eventLog" class="json-highlight">Waiting for change events...</pre>
        <button class="btn-clear" onclick="clearEventLog()" title="Clear">✕</button>
      </div>
    </div>

    <div class="section-box output error">
      <h3>Error Events:</h3>
      <p>
        When JSON is invalid, the component emits <code>error</code> events with:
        <strong>timestamp</strong>,
        <strong>error</strong> (error message),
        <strong>content</strong> (editor content for debugging)
      </p>
      <div class="log-container">
        <pre id="errorLog">No errors</pre>
        <button class="btn-clear" onclick="clearErrorLog()" title="Clear">✕</button>
      </div>
    </div>

    <div class="section-box code-example">
      <h3>HTML Code:</h3>
      <p>
        Copy this code to use the component in your own page (updates automatically with your settings)
      </p>
      <pre id="htmlCode"></pre>
    </div>

  </div>

  <!-- Theme Editor Modal -->
  <div id="themeModal" class="modal" style="display: none;">
    <div class="modal-backdrop" onclick="closeThemeModal()"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h3 style="display: flex; align-items: center; gap: 0.5rem;"><span class="icon-palette large"></span> Theme Editor</h3>
        <button class="modal-close" onclick="closeThemeModal()">×</button>
      </div>
      <div class="modal-body">
        <p style="color: #666; font-size: 0.85rem; margin-bottom: 1rem;">
          Customize the current theme. Edit the JSON below and click "Apply" to preview.<br>
          Use "Copy Code" to get the JavaScript snippet for your implementation.
        </p>
        <textarea id="themeTextarea" rows="20" spellcheck="false"></textarea>
        <div class="theme-actions">
          <button onclick="resetTheme()">Reset</button>
          <button onclick="copyTheme()">Copy</button>
          <button class="btn-action" onclick="applyTheme()">Apply</button>
        </div>
      </div>
    </div>
    <!-- Footer -->
    <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid var(--border-default); text-align: center;">
      <a href="https://www.softwarity.io/" target="_blank" rel="noopener noreferrer" style="color: var(--text-muted); text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem;">
        <img src="https://www.softwarity.io/img/softwarity.svg" alt="Softwarity" style="height: 20px; opacity: 0.7;">
        <span>Made by Softwarity</span>
      </a>
    </div>
  </div>

  <!-- API Modal -->
  <div id="apiModal" class="modal" style="display: none;">
    <div class="modal-backdrop" onclick="closeApiModal()"></div>
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h3 id="apiModalTitle">API Method</h3>
        <button class="modal-close" onclick="closeApiModal()">×</button>
      </div>
      <div class="modal-body api-modal-body">
        <!-- set() form -->
        <div id="apiFormSet" style="display: none;">
          <div class="form-group">
            <label for="apiSetTextarea">Features Array (JSON)</label>
            <textarea id="apiSetTextarea" placeholder='[{"type": "Feature", "geometry": {...}, "properties": {...}}]'></textarea>
          </div>
        </div>

        <!-- add() form -->
        <div id="apiFormAdd" style="display: none;">
          <div class="form-group">
            <label for="apiAddTextarea">Feature (JSON)</label>
            <textarea id="apiAddTextarea" placeholder='{"type": "Feature", "geometry": {"type": "Point", "coordinates": [0, 0]}, "properties": {}}'></textarea>
          </div>
        </div>

        <!-- insertAt() form -->
        <div id="apiFormInsertAt" style="display: none;">
          <div class="form-group">
            <label for="apiInsertAtTextarea">Feature (JSON)</label>
            <textarea id="apiInsertAtTextarea" placeholder='{"type": "Feature", "geometry": {"type": "Point", "coordinates": [0, 0]}, "properties": {}}'></textarea>
          </div>
          <div class="form-group">
            <label for="apiInsertAtIndex">Index (negative = from end)</label>
            <input type="number" id="apiInsertAtIndex" value="0" />
          </div>
        </div>

        <!-- removeAt() form -->
        <div id="apiFormRemoveAt" style="display: none;">
          <div class="form-group">
            <label for="apiRemoveAtIndex">Index (negative = from end, e.g. -1 = last)</label>
            <input type="number" id="apiRemoveAtIndex" value="0" />
          </div>
        </div>

        <div id="apiModalError" class="api-modal-error" style="display: none;"></div>

        <div class="api-modal-actions">
          <button onclick="closeApiModal()">Cancel</button>
          <button class="btn-action" onclick="executeApiMethod()">Execute</button>
        </div>
      </div>
    </div>
  </div>


  <script>
    const editor = document.getElementById('editor');
    const eventLog = document.getElementById('eventLog');
    const errorLog = document.getElementById('errorLog');
    const placeholderInput = document.getElementById('placeholderInput');
    const darkSelectorExampleSelect = document.getElementById('darkSelectorExampleSelect');
    const colorSchemeSelect = document.getElementById('colorSchemeSelect');
    const selectorPreview = document.getElementById('selectorPreview');
    const selectorDescription = document.getElementById('selectorDescription');
    const readonlyCheck = document.getElementById('readonlyCheck');
    const themeModal = document.getElementById('themeModal');
    const themeTextarea = document.getElementById('themeTextarea');
    const themePresetMainSelect = document.getElementById('themePresetMainSelect');
    const defaultPropsSelect = document.getElementById('defaultPropsSelect');
    const defaultPropsInput = document.getElementById('defaultPropsInput');
    const defaultPropsDescription = document.getElementById('defaultPropsDescription');

    // Default properties presets
    const defaultPropsPresets = {
      '': {
        value: '',
        description: '<strong>Disabled:</strong> No default properties will be added to features.'
      },
      'simple': {
        value: JSON.stringify({
          "fill-color": "#1a465b",
          "fill-opacity": 0.5,
          "stroke-color": "#0d2633",
          "stroke-width": 2
        }, null, 2),
        description: '<strong>Simple:</strong> Apply the same default styling properties to all features. Great for consistent visualization.'
      },
      'geometry': {
        value: JSON.stringify([
          { "match": { "geometry.type": "Polygon" }, "values": { "fill-color": "#58a6ff", "fill-opacity": 0.4, "stroke-color": "#58a6ff" } },
          { "match": { "geometry.type": "LineString" }, "values": { "stroke-color": "#a371f7", "stroke-width": 3 } },
          { "match": { "geometry.type": "Point" }, "values": { "fill-color": "#f85149", "stroke-color": "#ffffff", "stroke-width": 2 } }
        ], null, 2),
        description: '<strong>By Geometry Type:</strong> Apply different styles based on geometry type (Polygon, LineString, Point). Each type gets distinct colors.'
      },
      'combined': {
        value: JSON.stringify([
          { "values": { "stroke-width": 2, "stroke-color": "#333333" } },
          { "match": { "geometry.type": "Polygon" }, "values": { "fill-color": "#238636", "fill-opacity": 0.3 } },
          { "match": { "geometry.type": "Point" }, "values": { "fill-color": "#f85149" } },
          { "match": { "properties.highlighted": true }, "values": { "stroke-color": "#ff0000", "stroke-width": 4 } }
        ], null, 2),
        description: '<strong>Combined:</strong> First rule applies to all features (fallback). Following rules add/override for specific conditions. Try adding <code>"highlighted": true</code> to a feature\'s properties!'
      }
    };

    // Handle default properties preset selection
    defaultPropsSelect.addEventListener('change', (e) => {
      const preset = defaultPropsPresets[e.target.value];
      defaultPropsInput.value = preset.value;
      defaultPropsDescription.innerHTML = preset.description;
      updateEditor();
    });

    // Handle manual edit of default properties
    defaultPropsInput.addEventListener('input', () => {
      updateEditor();
    });

    // Initialize default properties UI
    function initDefaultPropsUI() {
      const preset = defaultPropsPresets[defaultPropsSelect.value];
      defaultPropsInput.value = preset.value;
      defaultPropsDescription.innerHTML = preset.description;
    }

    // Initialize MapLibre map with globe projection
    const map = new maplibregl.Map({
      container: 'map',
      style: 'https://demotiles.maplibre.org/style.json',
      center: [29.8, -3.4],
      zoom: 2
    });

    // Add navigation controls
    map.addControl(new maplibregl.NavigationControl(), 'top-right');

    // Store pending GeoJSON if map not ready yet
    let pendingGeojson = null;

    // Setup map when loaded
    map.on('load', () => {
      // Set globe projection for 3D Earth view
      map.setProjection({ type: 'globe' });

      // Add GeoJSON source
      map.addSource('geojson-data', {
        type: 'geojson',
        data: { type: 'FeatureCollection', features: [] }
      });

      // Add vertices source (for features with marker: true)
      map.addSource('vertices-data', {
        type: 'geojson',
        data: { type: 'FeatureCollection', features: [] }
      });

      // Polygon fill layer
      map.addLayer({
        id: 'geojson-fill',
        type: 'fill',
        source: 'geojson-data',
        filter: ['==', '$type', 'Polygon'],
        paint: {
          'fill-color': ['coalesce', ['get', 'fill-color'], '#58a6ff'],
          'fill-opacity': ['coalesce', ['get', 'fill-opacity'], 0.4]
        }
      });

      // Polygon outline layer
      map.addLayer({
        id: 'geojson-outline',
        type: 'line',
        source: 'geojson-data',
        filter: ['==', '$type', 'Polygon'],
        paint: {
          'line-color': ['coalesce', ['get', 'stroke-color'], '#58a6ff'],
          'line-width': ['coalesce', ['get', 'stroke-width'], 2]
        }
      });

      // LineString layer
      map.addLayer({
        id: 'geojson-line',
        type: 'line',
        source: 'geojson-data',
        filter: ['==', '$type', 'LineString'],
        paint: {
          'line-color': ['coalesce', ['get', 'stroke-color'], '#a371f7'],
          'line-width': ['coalesce', ['get', 'stroke-width'], 3]
        }
      });

      // Point layer
      map.addLayer({
        id: 'geojson-point',
        type: 'circle',
        source: 'geojson-data',
        filter: ['==', '$type', 'Point'],
        paint: {
          'circle-radius': 8,
          'circle-color': ['coalesce', ['get', 'fill-color'], '#f85149'],
          'circle-stroke-color': ['coalesce', ['get', 'stroke-color'], '#ffffff'],
          'circle-stroke-width': ['coalesce', ['get', 'stroke-width'], 2]
        }
      });

      // Label layer for features with 'label' property
      map.addLayer({
        id: 'geojson-labels',
        type: 'symbol',
        source: 'geojson-data',
        filter: ['has', 'label'],
        layout: {
          'text-field': ['get', 'label'],
          'text-size': ['coalesce', ['get', 'label-size'], 14],
          'text-anchor': 'center',
          'text-allow-overlap': false
        },
        paint: {
          'text-color': ['coalesce', ['get', 'label-color'], '#ffffff'],
          'text-halo-color': ['coalesce', ['get', 'label-halo-color'], '#000000'],
          'text-halo-width': ['coalesce', ['get', 'label-halo-width'], 1.5]
        }
      });

      // Vertices layer (for LineString/Polygon with marker: true)
      map.addLayer({
        id: 'geojson-vertices',
        type: 'circle',
        source: 'vertices-data',
        paint: {
          'circle-radius': ['coalesce', ['get', 'marker-width'], 5],
          'circle-color': ['coalesce', ['get', 'marker-color'], '#ff6b35'],
          'circle-opacity': ['coalesce', ['get', 'marker-opacity'], 0.9],
          'circle-stroke-width': 1,
          'circle-stroke-color': '#ffffff'
        }
      });

      // Apply pending GeoJSON if data was loaded before map was ready
      if (pendingGeojson) {
        updateMap(pendingGeojson);
        pendingGeojson = null;
      }
    });

    // Extract all coordinates from a geometry
    function extractCoordinates(geometry) {
      if (!geometry) return [];
      switch (geometry.type) {
        case 'Point':
          return [geometry.coordinates];
        case 'MultiPoint':
        case 'LineString':
          return geometry.coordinates;
        case 'MultiLineString':
        case 'Polygon':
          return geometry.coordinates.flat();
        case 'MultiPolygon':
          return geometry.coordinates.flat(2);
        default:
          return [];
      }
    }

    // Extract vertices from features that have marker: true
    function extractVertices(featureCollection) {
      const vertexFeatures = [];
      if (!featureCollection || !featureCollection.features) {
        return { type: 'FeatureCollection', features: [] };
      }
      featureCollection.features.forEach(feature => {
        // Only process if marker property is true
        if (!feature.properties || feature.properties.marker !== true) {
          return;
        }
        // Skip Point geometries (they are already displayed as points)
        if (feature.geometry && feature.geometry.type === 'Point') {
          return;
        }
        const props = feature.properties;
        const markerColor = props['marker-color'] || props['stroke-color'] || '#ff6b35';
        const markerOpacity = props['marker-opacity'];
        const markerWidth = props['marker-width'];
        const coords = extractCoordinates(feature.geometry);
        coords.forEach(coord => {
          const vertexProps = { 'marker-color': markerColor };
          if (markerOpacity !== undefined) vertexProps['marker-opacity'] = markerOpacity;
          if (markerWidth !== undefined) vertexProps['marker-width'] = markerWidth;
          vertexFeatures.push({
            type: 'Feature',
            geometry: { type: 'Point', coordinates: coord },
            properties: vertexProps
          });
        });
      });
      return { type: 'FeatureCollection', features: vertexFeatures };
    }

    // Function to update map with GeoJSON data
    function updateMap(geojson) {
      if (!map.getSource('geojson-data')) {
        // Map not ready, store for later
        pendingGeojson = geojson;
        return;
      }

      try {
        map.getSource('geojson-data').setData(geojson);

        // Extract and display vertices for features with marker: true
        const vertices = extractVertices(geojson);
        if (map.getSource('vertices-data')) {
          map.getSource('vertices-data').setData(vertices);
        }

        // Fit bounds to data if there are features
        if (geojson.features && geojson.features.length > 0) {
          const bounds = new maplibregl.LngLatBounds();
          let hasValidCoords = false;

          geojson.features.forEach(feature => {
            if (!feature.geometry) return;
            const addCoords = (coords) => {
              if (Array.isArray(coords[0])) {
                coords.forEach(addCoords);
              } else if (coords.length >= 2) {
                bounds.extend([coords[0], coords[1]]);
                hasValidCoords = true;
              }
            };
            if (feature.geometry.coordinates) {
              addCoords(feature.geometry.coordinates);
            }
          });

          if (hasValidCoords) {
            map.fitBounds(bounds, {
              padding: 50,
              maxZoom: 12,
              duration: 1000
            });
          }
        }
      } catch (e) {
        console.warn('Failed to update map:', e);
      }
    }

    // Pre-defined theme presets
    // Keys are camelCase and will be converted to kebab-case CSS variables (e.g., bgColor → --bg-color)
    const themePresets = {
      intellij: {
        dark: {
          bgColor: '#2b2b2b', textColor: '#a9b7c6', caretColor: '#bbbbbb',
          gutterBg: '#313335', gutterBorder: '#3c3f41',
          jsonKey: '#9876aa', jsonString: '#6a8759', jsonNumber: '#6897bb',
          jsonBoolean: '#cc7832', jsonNull: '#cc7832', jsonPunct: '#a9b7c6',
          controlColor: '#cc7832', controlBg: '#3c3f41', controlBorder: '#5a5a5a',
          geojsonKey: '#9876aa', geojsonType: '#6a8759', geojsonTypeInvalid: '#ff6b68', jsonKeyInvalid: '#ff6b68'
        },
        light: {
          bgColor: '#ffffff', textColor: '#000000', caretColor: '#000000',
          gutterBg: '#f0f0f0', gutterBorder: '#e0e0e0',
          jsonKey: '#660e7a', jsonString: '#008000', jsonNumber: '#0000ff',
          jsonBoolean: '#000080', jsonNull: '#000080', jsonPunct: '#000000',
          controlColor: '#000080', controlBg: '#e8e8e8', controlBorder: '#c0c0c0',
          geojsonKey: '#660e7a', geojsonType: '#008000', geojsonTypeInvalid: '#ff0000', jsonKeyInvalid: '#ff0000'
        }
      },
      vscode: {
        dark: {
          bgColor: '#1e1e1e', textColor: '#d4d4d4', caretColor: '#fff',
          gutterBg: '#252526', gutterBorder: '#3e3e42',
          jsonKey: '#9cdcfe', jsonString: '#ce9178', jsonNumber: '#b5cea8',
          jsonBoolean: '#569cd6', jsonNull: '#569cd6', jsonPunct: '#d4d4d4',
          controlColor: '#c586c0', controlBg: '#3e3e42', controlBorder: '#555',
          geojsonKey: '#c586c0', geojsonType: '#4ec9b0', geojsonTypeInvalid: '#f44747', jsonKeyInvalid: '#f44747'
        },
        light: {
          bgColor: '#ffffff', textColor: '#333333', caretColor: '#000',
          gutterBg: '#f5f5f5', gutterBorder: '#ddd',
          jsonKey: '#0000ff', jsonString: '#a31515', jsonNumber: '#098658',
          jsonBoolean: '#0000ff', jsonNull: '#0000ff', jsonPunct: '#333333',
          controlColor: '#a31515', controlBg: '#e0e0e0', controlBorder: '#999',
          geojsonKey: '#af00db', geojsonType: '#267f99', geojsonTypeInvalid: '#d32f2f', jsonKeyInvalid: '#d32f2f'
        }
      },
      github: {
        dark: {
          bgColor: '#0d1117', textColor: '#c9d1d9', caretColor: '#c9d1d9',
          gutterBg: '#161b22', gutterBorder: '#30363d',
          jsonKey: '#79c0ff', jsonString: '#a5d6ff', jsonNumber: '#79c0ff',
          jsonBoolean: '#ff7b72', jsonNull: '#ff7b72', jsonPunct: '#c9d1d9',
          controlColor: '#d2a8ff', controlBg: '#30363d', controlBorder: '#484f58',
          geojsonKey: '#d2a8ff', geojsonType: '#7ee787', geojsonTypeInvalid: '#f85149', jsonKeyInvalid: '#f85149'
        },
        light: {
          bgColor: '#ffffff', textColor: '#24292f', caretColor: '#24292f',
          gutterBg: '#f6f8fa', gutterBorder: '#d0d7de',
          jsonKey: '#0550ae', jsonString: '#0a3069', jsonNumber: '#0550ae',
          jsonBoolean: '#cf222e', jsonNull: '#cf222e', jsonPunct: '#24292f',
          controlColor: '#8250df', controlBg: '#eaeef2', controlBorder: '#afb8c1',
          geojsonKey: '#8250df', geojsonType: '#116329', geojsonTypeInvalid: '#cf222e', jsonKeyInvalid: '#cf222e'
        }
      },
      onedark: {
        dark: {
          bgColor: '#282c34', textColor: '#abb2bf', caretColor: '#528bff',
          gutterBg: '#21252b', gutterBorder: '#3e4451',
          jsonKey: '#e06c75', jsonString: '#98c379', jsonNumber: '#d19a66',
          jsonBoolean: '#d19a66', jsonNull: '#d19a66', jsonPunct: '#abb2bf',
          controlColor: '#c678dd', controlBg: '#3e4451', controlBorder: '#4b5263',
          geojsonKey: '#c678dd', geojsonType: '#56b6c2', geojsonTypeInvalid: '#e06c75', jsonKeyInvalid: '#e06c75'
        },
        light: {
          bgColor: '#fafafa', textColor: '#383a42', caretColor: '#526fff',
          gutterBg: '#f0f0f0', gutterBorder: '#e0e0e0',
          jsonKey: '#e45649', jsonString: '#50a14f', jsonNumber: '#986801',
          jsonBoolean: '#986801', jsonNull: '#986801', jsonPunct: '#383a42',
          controlColor: '#a626a4', controlBg: '#e0e0e0', controlBorder: '#999',
          geojsonKey: '#a626a4', geojsonType: '#0184bc', geojsonTypeInvalid: '#e45649', jsonKeyInvalid: '#e45649'
        }
      },
      solarized: {
        dark: {
          bgColor: '#002b36', textColor: '#839496', caretColor: '#839496',
          gutterBg: '#073642', gutterBorder: '#094652',
          jsonKey: '#268bd2', jsonString: '#2aa198', jsonNumber: '#d33682',
          jsonBoolean: '#cb4b16', jsonNull: '#cb4b16', jsonPunct: '#839496',
          controlColor: '#6c71c4', controlBg: '#073642', controlBorder: '#586e75',
          geojsonKey: '#6c71c4', geojsonType: '#859900', geojsonTypeInvalid: '#dc322f', jsonKeyInvalid: '#dc322f'
        },
        light: {
          bgColor: '#fdf6e3', textColor: '#657b83', caretColor: '#657b83',
          gutterBg: '#eee8d5', gutterBorder: '#e0dbc8',
          jsonKey: '#268bd2', jsonString: '#2aa198', jsonNumber: '#d33682',
          jsonBoolean: '#cb4b16', jsonNull: '#cb4b16', jsonPunct: '#657b83',
          controlColor: '#6c71c4', controlBg: '#eee8d5', controlBorder: '#93a1a1',
          geojsonKey: '#6c71c4', geojsonType: '#859900', geojsonTypeInvalid: '#dc322f', jsonKeyInvalid: '#dc322f'
        }
      }
    };
    const htmlCode = document.getElementById('htmlCode');

    // Internal dark selector value
    let darkSelector = '.dark';

    // Selector descriptions explaining what each selector does
    const selectorDescriptions = {
      '.dark': '<strong>Example:</strong> <code>.dark</code> — The component watches for a <code>dark</code> class on itself. When present, dark theme is applied.',
      'html.dark': '<strong>Example:</strong> <code>html.dark</code> — The component watches for a <code>dark</code> class on the <code>&lt;html&gt;</code> element. Useful when your page uses a global dark mode class.',
      'html[data-bs-theme=dark]': '<strong>Example:</strong> <code>html[data-bs-theme=dark]</code> — The component watches for a <code>data-bs-theme="dark"</code> attribute on the <code>&lt;html&gt;</code> element.'
    };

    // Handle dark selector example selection
    darkSelectorExampleSelect.addEventListener('change', (e) => {
      darkSelector = e.target.value;
      selectorPreview.value = `dark-selector="${darkSelector}"`;
      selectorDescription.innerHTML = selectorDescriptions[darkSelector];
      updateEditor();
      applyColorScheme();
    });

    // Parse dark selector to determine target element
    function parseSelector(selector) {
      // Check for class on component itself (.dark)
      if (selector.startsWith('.') && !selector.includes(' ')) {
        return {
          target: 'component',
          type: 'class',
          value: selector.substring(1) // Remove the dot
        };
      }

      // Check for class on html (html.dark)
      const htmlClassMatch = selector.match(/^html\.(.+)$/);
      if (htmlClassMatch) {
        return {
          target: 'html',
          type: 'class',
          value: htmlClassMatch[1]
        };
      }

      // Check for attribute on html (html[data-bs-theme=dark])
      const htmlAttrMatch = selector.match(/^html\[([^=]+)=([^\]]+)\]$/);
      if (htmlAttrMatch) {
        return {
          target: 'html',
          type: 'attribute',
          attr: htmlAttrMatch[1],
          value: htmlAttrMatch[2]
        };
      }

      return null;
    }

    // Apply color scheme by modifying the appropriate target
    function applyColorScheme() {
      const scheme = colorSchemeSelect.value;
      const isDark = scheme === 'dark';

      const target = parseSelector(darkSelector);
      if (!target) return;

      // Apply to component
      if (target.target === 'component') {
        if (isDark) {
          editor.classList.add(target.value);
        } else {
          editor.classList.remove(target.value);
        }
      }

      // Apply to html element
      if (target.target === 'html') {
        if (target.type === 'class') {
          if (isDark) {
            document.documentElement.classList.add(target.value);
          } else {
            document.documentElement.classList.remove(target.value);
          }
        } else if (target.type === 'attribute') {
          // For Bootstrap: set attribute to "dark" or "light"
          document.documentElement.setAttribute(target.attr, scheme);
        }
      }

    }

    // Update editor attributes from inputs
    function updateEditor() {
      editor.setAttribute('placeholder', placeholderInput.value);
      editor.setAttribute('dark-selector', darkSelector);

      if (readonlyCheck.checked) {
        editor.setAttribute('readonly', '');
      } else {
        editor.removeAttribute('readonly');
      }

      // Apply default-properties attribute
      const defaultPropsValue = defaultPropsInput.value.trim();
      if (defaultPropsValue) {
        editor.setAttribute('default-properties', defaultPropsValue);
      } else {
        editor.removeAttribute('default-properties');
      }

      updateHTMLCode();
    }

    // Update HTML code display
    function updateHTMLCode() {
      const placeholder = placeholderInput.value;
      const readonly = readonlyCheck.checked;
      const scheme = colorSchemeSelect.value;
      const isDark = scheme === 'dark';
      const defaultPropsValue = defaultPropsInput.value.trim();

      // Parse selector to understand its type
      const selectorTarget = parseSelector(darkSelector);

      // Build component attributes (always in FeatureCollection mode)
      let attrs = [];
      if (placeholder) attrs.push(`placeholder="${placeholder.replace(/"/g, '&quot;')}"`);
      if (readonly) attrs.push('readonly');
      if (darkSelector) attrs.push(`dark-selector="${darkSelector.replace(/"/g, '&quot;')}"`);
      if (defaultPropsValue) {
        // Minify the JSON for the HTML output
        try {
          const minified = JSON.stringify(JSON.parse(defaultPropsValue));
          attrs.push(`default-properties='${minified}'`);
        } catch (e) {
          // If invalid JSON, use as-is
          attrs.push(`default-properties='${defaultPropsValue.replace(/'/g, "\\'")}'`);
        }
      }

      // Build HTML tag attributes based on selector type
      let htmlAttrs = 'lang="en"';
      let componentClass = '';

      if (selectorTarget) {
        if (selectorTarget.target === 'html') {
          if (selectorTarget.type === 'class' && isDark) {
            htmlAttrs += ` class="${selectorTarget.value}"`;
          } else if (selectorTarget.type === 'attribute') {
            htmlAttrs += ` ${selectorTarget.attr}="${scheme}"`;
          }
        } else if (selectorTarget.target === 'component' && isDark) {
          componentClass = ` class="${selectorTarget.value}"`;
        }
      }

      let code = '<!DOCTYPE html>\n';
      code += `<html ${htmlAttrs}>\n`;
      code += '<head>\n';
      code += '  <meta charset="UTF-8">\n';
      code += '  <title>GeoJSON Editor</title>\n';
      code += '  <script type="module">\n';
      code += '    const editor = document.querySelector(\'geojson-editor\');\n\n';
      code += '    // Valid GeoJSON - emits parsed object directly\n';
      code += '    editor.addEventListener(\'change\', (e) => {\n';
      code += '      console.log(\'GeoJSON:\', e.detail);\n';
      code += '    });\n\n';
      code += '    // Invalid JSON or GeoJSON validation error\n';
      code += '    editor.addEventListener(\'error\', (e) => {\n';
      code += '      console.error(\'Error:\', e.detail.error);\n';
      code += '    });\n';
      code += '  <\/script>\n';
      code += '</head>\n';
      code += '<body>\n';
      code += `  <geojson-editor${componentClass}\n`;
      code += '    ' + attrs.join('\n    ') + '\n';
      code += '  ></geojson-editor>\n\n';
      code += '  <script type="module" src="https://unpkg.com/@softwarity/geojson-editor"><\/script>\n';
      code += '</body>\n';
      code += '</html>';

      // Apply HTML syntax highlighting with Prism.js
      htmlCode.innerHTML = Prism.highlight(code, Prism.languages.markup, 'markup');
    }

    // Listen to editor change events (valid JSON parsed object)
    editor.addEventListener('change', (e) => {
      const jsonStr = JSON.stringify(e.detail, null, 2);
      // Apply Prism.js JSON highlighting
      eventLog.innerHTML = Prism.highlight(jsonStr, Prism.languages.json, 'json');
      // Clear error log on successful parse
      errorLog.textContent = 'No errors';
      errorLog.style.color = '';
      // Update map with the GeoJSON data
      updateMap(e.detail);
    });

    // Listen to editor error events (invalid JSON)
    editor.addEventListener('error', (e) => {
      errorLog.textContent = JSON.stringify(e.detail, null, 2);
      errorLog.style.color = '#f85149';
    });

    // Clear event/error logs
    function clearEventLog() {
      eventLog.textContent = 'Waiting for change events...';
    }

    function clearErrorLog() {
      errorLog.textContent = 'No errors';
      errorLog.style.color = '';
    }

    // Listen to input changes
    placeholderInput.addEventListener('input', updateEditor);
    readonlyCheck.addEventListener('change', updateEditor);

    // Color scheme change - applies to the selector target and updates HTML code
    colorSchemeSelect.addEventListener('change', () => {
      applyColorScheme();
      updateHTMLCode(); // Update the generated HTML code to reflect the new scheme
    });

    // Apply preset theme directly from main selector
    themePresetMainSelect.addEventListener('change', () => {
      const presetName = themePresetMainSelect.value;
      if (presetName && themePresets[presetName]) {
        editor.setTheme(themePresets[presetName]);
      }
    });

    // Open theme modal
    function openThemeModal() {
      loadCurrentTheme();
      themeModal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }

    // Close theme modal
    function closeThemeModal() {
      themeModal.style.display = 'none';
      document.body.style.overflow = '';
    }

    // Close modal on Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && themeModal.style.display === 'flex') {
        closeThemeModal();
      }
    });

    // Load current theme preset into textarea
    function loadCurrentTheme() {
      const presetName = themePresetMainSelect.value || 'intellij';
      const theme = themePresets[presetName] || themePresets.intellij;
      themeTextarea.value = JSON.stringify(theme, null, 2);
    }

    // Apply theme from textarea
    function applyTheme() {
      try {
        const theme = JSON.parse(themeTextarea.value);
        editor.setTheme(theme);
        showThemeMessage('✓ Theme applied!', 'success');
      } catch (e) {
        showThemeMessage('✗ Invalid JSON: ' + e.message, 'error');
      }
    }

    // Reset to default theme (IntelliJ)
    function resetTheme() {
      themePresetMainSelect.value = 'intellij';
      editor.setTheme(themePresets.intellij);
      loadCurrentTheme();
      showThemeMessage('↺ Theme reset to IntelliJ default', 'success');
    }

    // Copy theme to clipboard
    function copyTheme() {
      const themeCode = `// Apply custom theme to GeoJSON Editor
const editor = document.querySelector('geojson-editor');
editor.setTheme(${themeTextarea.value});`;

      navigator.clipboard.writeText(themeCode).then(() => {
        showThemeMessage('📋 Theme code copied to clipboard!', 'success');
      }).catch(() => {
        showThemeMessage('✗ Failed to copy', 'error');
      });
    }

    // Show feedback message as centered toast overlay in theme modal
    function showThemeMessage(message, type) {
      const modalContent = themeModal.querySelector('.modal-content');
      const existing = modalContent.querySelector('.theme-toast');
      if (existing) existing.remove();

      const toast = document.createElement('div');
      toast.className = 'theme-toast';
      toast.style.cssText = `
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 1rem 1.5rem;
        border-radius: 8px;
        font-size: 0.95rem;
        font-weight: 500;
        background: ${type === 'success' ? 'rgba(40, 167, 69, 0.95)' : 'rgba(220, 53, 69, 0.95)'};
        color: white;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        z-index: 10;
        animation: toastFadeIn 0.2s ease-out;
      `;
      toast.textContent = message;
      modalContent.style.position = 'relative';
      modalContent.appendChild(toast);

      setTimeout(() => {
        toast.style.animation = 'toastFadeOut 0.3s ease-out forwards';
        setTimeout(() => toast.remove(), 300);
      }, 2000);
    }

    // ========================================
    // API Modal Functions
    // ========================================
    const apiModal = document.getElementById('apiModal');
    const apiModalTitle = document.getElementById('apiModalTitle');
    const apiModalError = document.getElementById('apiModalError');
    let currentApiMethod = null;

    // Open API modal for a specific method
    function openApiModal(method) {
      currentApiMethod = method;

      // Hide all forms
      document.querySelectorAll('[id^="apiForm"]').forEach(el => el.style.display = 'none');
      apiModalError.style.display = 'none';

      // Show the relevant form
      const formId = 'apiForm' + method.charAt(0).toUpperCase() + method.slice(1);
      const form = document.getElementById(formId);
      if (form) form.style.display = 'block';

      // Update title
      const titles = {
        set: 'set(features[])',
        add: 'add(feature)',
        insertAt: 'insertAt(feature, index)',
        removeAt: 'removeAt(index)'
      };
      apiModalTitle.textContent = titles[method] || method;

      // Pre-fill with sample feature for add/insertAt
      if (method === 'add' || method === 'insertAt') {
        const sampleFeature = {
          type: 'Feature',
          geometry: { type: 'Point', coordinates: [29.5, -3.0] },
          properties: { name: 'New Point' }
        };
        const textarea = document.getElementById(method === 'add' ? 'apiAddTextarea' : 'apiInsertAtTextarea');
        if (textarea && !textarea.value.trim()) {
          textarea.value = JSON.stringify(sampleFeature, null, 2);
        }
      }

      // Pre-fill set with current features
      if (method === 'set') {
        const textarea = document.getElementById('apiSetTextarea');
        const currentFeatures = editor.getAll();
        if (textarea) {
          textarea.value = JSON.stringify(currentFeatures, null, 2);
        }
      }

      apiModal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }

    // Close API modal
    function closeApiModal() {
      apiModal.style.display = 'none';
      document.body.style.overflow = '';
      currentApiMethod = null;
    }

    // Execute the current API method
    function executeApiMethod() {
      apiModalError.style.display = 'none';

      try {
        switch (currentApiMethod) {
          case 'set': {
            const textarea = document.getElementById('apiSetTextarea');
            const features = JSON.parse(textarea.value);
            if (!Array.isArray(features)) {
              throw new Error('Value must be an array of features');
            }
            editor.set(features);
            break;
          }
          case 'add': {
            const textarea = document.getElementById('apiAddTextarea');
            const feature = JSON.parse(textarea.value);
            editor.add(feature);
            break;
          }
          case 'insertAt': {
            const textarea = document.getElementById('apiInsertAtTextarea');
            const indexInput = document.getElementById('apiInsertAtIndex');
            const feature = JSON.parse(textarea.value);
            const index = parseInt(indexInput.value, 10);
            editor.insertAt(feature, index);
            break;
          }
          case 'removeAt': {
            const indexInput = document.getElementById('apiRemoveAtIndex');
            const index = parseInt(indexInput.value, 10);
            const removed = editor.removeAt(index);
            if (removed === undefined) {
              throw new Error('Index out of bounds');
            }
            break;
          }
        }
        closeApiModal();
      } catch (e) {
        apiModalError.textContent = e.message;
        apiModalError.style.display = 'block';
      }
    }

    // Direct API actions (no modal)
    function apiRemoveAll() {
      editor.removeAll();
    }

    function apiEmit() {
      editor.emit();
    }

    // Close API modal on Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && apiModal.style.display === 'flex') {
        closeApiModal();
      }
    });

    // Sample features array with styling properties
    const sampleFeaturesArray = [
      {
        type: "Feature",
        geometry: {
          type: "MultiPolygon",
          coordinates: [[[[30.42472267,-2.31472206],[30.44166756,-2.30805588],[30.46166801,-2.3488884],[30.50499916,-2.38111114],[30.57333183,-2.39916611],[30.5233326,-2.45777702],[30.50152891,-2.52458305],[30.47972298,-2.5913887],[30.43305397,-2.64777756],[30.43083382,-2.67111015],[30.45722389,-2.68583298],[30.52277946,-2.64888763],[30.48999977,-2.70722198],[30.46333504,-2.71527862],[30.44027901,-2.74722099],[30.44833183,-2.77750015],[30.42749977,-2.80527687],[30.41750145,-2.8619442],[30.47055626,-2.90416717],[30.4849987,-2.94722176],[30.51055717,-2.94361114],[30.56333351,-2.89305496],[30.60611053,-2.91916738],[30.64888954,-2.94527817],[30.6661129,-2.97638893],[30.70305443,-2.96750069],[30.75444603,-2.99138832],[30.79961236,-2.98370168],[30.84477806,-2.97601318],[30.79555702,-3.04861069],[30.8338871,-3.08555603],[30.83194542,-3.12416649],[30.85222054,-3.14527702],[30.84222221,-3.20027733],[30.8227787,-3.22194481],[30.83500099,-3.25694466],[30.76749992,-3.29999924],[30.74083519,-3.27861023],[30.73027611,-3.3022213],[30.65166664,-3.33250046],[30.62220192,-3.37011337],[30.66361046,-3.38666534],[30.66222191,-3.41888809],[30.62833214,-3.45388794],[30.58138935,-3.47152826],[30.53444481,-3.48916626],[30.51972389,-3.51555633],[30.49138832,-3.50722122],[30.44916725,-3.54722214],[30.44360924,-3.61249924],[30.41750098,-3.66180458],[30.39138985,-3.71110916],[30.40083504,-3.78610992],[30.34610939,-3.7705555],[30.32111168,-3.78666687],[30.29583168,-3.85055542],[30.26194538,-3.88930579],[30.22805595,-3.92805481],[30.21916822,-3.97499948],[30.21027946,-4.02194405],[30.17222405,-4.08666611],[30.12750053,-4.13833427],[30.0727787,-4.16666603],[30.04944574,-4.21805512],[30.0261097,-4.26944351],[29.98403113,-4.29486384],[29.94194976,-4.32028186],[29.89986557,-4.34569755],[29.85777855,-4.37111092],[29.81277657,-4.36027718],[29.78250137,-4.41069474],[29.75222206,-4.46111107],[29.70488876,-4.45280131],[29.65755653,-4.44448853],[29.59913943,-4.44538712],[29.54072218,-4.4462811],[29.48230478,-4.44717049],[29.42388725,-4.44805527],[29.41249493,-4.36944462],[29.40110501,-4.29083381],[29.38971742,-4.21222283],[29.37833214,-4.13361168],[29.35874826,-4.08736157],[29.33916664,-4.04111099],[29.28777305,-3.97861259],[29.23638725,-3.91611099],[29.22999907,-3.8527775],[29.22361183,-3.78944397],[29.22944642,-3.7406941],[29.23528036,-3.6919442],[29.24111367,-3.64319426],[29.24694634,-3.59444427],[29.23729107,-3.52374998],[29.22763728,-3.45305558],[29.21798492,-3.38236108],[29.20833397,-3.31166649],[29.23696709,-3.27186584],[29.21055412,-3.23666573],[29.21277809,-3.15194511],[29.24055672,-3.11777687],[29.23777962,-3.05805588],[29.21916771,-3.02111053],[29.17500114,-3.0177784],[29.14861107,-2.99611092],[29.14055443,-2.95833206],[29.08416557,-2.92472267],[29.07944298,-2.88360977],[29.04083443,-2.81888771],[29.00277901,-2.82277679],[28.98388863,-2.80027771],[28.99305534,-2.76166534],[29.03888893,-2.73361015],[29.0522213,-2.70583343],[29.0529156,-2.65972233],[29.05360985,-2.61361122],[29.07139015,-2.59638786],[29.14055443,-2.58916664],[29.17666817,-2.6147213],[29.25277782,-2.63416808],[29.32888985,-2.65361023],[29.32583427,-2.68332863],[29.35666847,-2.72138786],[29.33722115,-2.76361084],[29.36722374,-2.82500076],[29.44389153,-2.79583359],[29.48874988,-2.81097307],[29.53360939,-2.82611084],[29.5850001,-2.80291765],[29.63638878,-2.77972221],[29.68055534,-2.80388832],[29.73638725,-2.80361175],[29.76527595,-2.75833321],[29.81583214,-2.7733326],[29.85083199,-2.75972176],[29.90749931,-2.69305611],[29.92194557,-2.65277862],[29.92263988,-2.58583355],[29.92333412,-2.51888847],[29.95472145,-2.47500038],[29.94499932,-2.42291645],[29.93527794,-2.37083244],[29.95222282,-2.30944443],[29.98305702,-2.34055519],[30.02083397,-2.33722305],[30.05888836,-2.374723],[30.09694481,-2.41222191],[30.15361214,-2.43055534],[30.1863907,-2.39805547],[30.21916771,-2.36555481],[30.22972298,-2.33638763],[30.28594399,-2.35598755],[30.35639,-2.33638763],[30.38110924,-2.2994442],[30.42472267,-2.31472206]]]]
        },
        properties: {
          label: "HBBA FIR",
          "label-color": "#ffffff",
          "label-size": 16,
          "label-halo-color": "#1a5c1d",
          "label-halo-width": 2,
          "fill-color": "#277A2B",
          "fill-opacity": 0.4,
          "stroke-color": "#9e293a",
          "stroke-width": 3
        }
      },
      {
        type: "Feature",
        geometry: { type: "Point", coordinates: [29.3189, -3.3240] },
        properties: {
          label: "HBBA",
          "label-color": "#ffffff",
          "label-size": 12,
          "fill-color": "#e74c3c",
          "stroke-color": "#ffffff",
          "stroke-width": 2,
          marker: true
        }
      },
      {
        type: "Feature",
        geometry: { type: "LineString", coordinates: [[29.3189, -3.3240], [30.1, -2.8], [30.5, -2.5]] },
        properties: {
          label: "Airway",
          "label-color": "#3498db",
          "stroke-color": "#3498db",
          "stroke-width": 2,
          marker: true,
          "marker-color": "#ff6b35",
          "marker-width": 6
        }
      }
    ];

    // Load sample data (always in FeatureCollection mode - just the features array content)
    function loadSampleData() {
      const featuresStr = sampleFeaturesArray.map(f => JSON.stringify(f, null, 2)).join(',\n');
      editor.setAttribute('value', featuresStr);
    }

    function clearEditor() {
      editor.setAttribute('value', '');
    }

    // Load initial sample automatically after component is ready
    customElements.whenDefined('geojson-editor').then(() => {
      initDefaultPropsUI();
      updateEditor();
      applyColorScheme();
      loadSampleData();
    });
  </script>
  <script type="module" src="../src/geojson-editor.js"></script>
</body>
</html>
